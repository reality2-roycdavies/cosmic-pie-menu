# Development Transcript: cosmic-pie-menu v0.2.0

Session focused on adding running app detection and improving stability.

**Date**: January 23, 2026

**Participants**: Dr. Roy C. Davies (Human) and Claude (AI Assistant)

**Tool**: Claude Code

**Version**: 0.1.0 → 0.2.0

---

## Session Summary

This session added several major features and fixes:

1. **Running App Detection** - Implemented detection of currently running applications using the `ext_foreign_toplevel_list_v1` Wayland protocol
2. **Running Indicators** - Added grey arc indicators near the inner circle for running apps
3. **Non-Favorite Running Apps** - Menu now shows running apps that aren't dock favorites
4. **Desktop File Matching** - Improved matching for apps like "Slack" → "com.slack.Slack.desktop"
5. **Suspend/Resume Fix** - Changed to full-screen anchored layer surface for reliable display after resume

---

## Key Technical Challenges

### Challenge 1: Wayland Protocol for Running Apps

**Problem**: Need to detect which applications are currently running.

**Discovery**: COSMIC doesn't support `zwlr_foreign_toplevel_manager_v1` (wlroots protocol), but does support `ext_foreign_toplevel_list_v1` (extension protocol).

**Solution**: Implemented Wayland client using `wayland-client` and `wayland-protocols` crates with the `event_created_child!` macro for handling child toplevel handle objects.

### Challenge 2: Wayland Connection Conflicts

**Problem**: After adding running app detection, the pie menu would appear briefly then disappear.

**Discovery**: The Wayland connection for toplevel detection conflicted with libcosmic's connection.

**Solution**: Query running apps via subprocess (`--query-running` flag) to isolate Wayland connections.

### Challenge 3: Invisible Window After Resume

**Problem**: After suspend/resume, the menu window existed (receiving input events) but nothing was visible.

**Discovery**: Debug output showed mouse hover events and keyboard input were being processed, but rendering failed silently.

**Solution**: Changed from fixed-size centered window (`Anchor::empty()`) to full-screen anchored surface (`Anchor::TOP | BOTTOM | LEFT | RIGHT`). The compositor handles full-screen surfaces more reliably after resume.

### Challenge 4: Desktop File Matching

**Problem**: Running apps report app_ids like "Slack" but desktop files are named "com.slack.Slack.desktop".

**Solution**: Added fuzzy matching that checks if the app_id matches the last component of the desktop file name (case-insensitive).

---

## Code Changes

### New Files
- `src/windows.rs` - Wayland toplevel detection module (168 lines)

### Modified Files
- `Cargo.toml` - Added wayland-client and wayland-protocols dependencies
- `src/main.rs` - Added subprocess query and `--query-running` mode
- `src/apps.rs` - Added running status, improved desktop file matching
- `src/pie_menu.rs` - Added arc indicators, full-screen layer surface

### Lines Changed
- 744 insertions, 70 deletions across 6 files

---

## Notable Debugging Session

The "invisible window" bug was particularly interesting:

```
Human: still see nothing:
DEBUG: new_at called with 12 apps, position None
DEBUG: menu_radius=190.98593, menu_size=509.97186
DEBUG: new_at complete, requesting layer surface
DEBUG: update called with Tick
DEBUG: update called with CanvasEvent(HoverSegment(Some(5)))
DEBUG: update called with CanvasEvent(HoverSegment(Some(6)))
DEBUG: update called with KeyPressed(Named(Escape))
```

The window was receiving and processing all events correctly, but rendering nothing. This led to the discovery that full-screen anchored surfaces are more reliable with COSMIC's compositor, especially after suspend/resume cycles.

---

## Conversation Highlights

### On Web App Detection
> Human: "one of the challenges is going to be figuring out what the apps actually are, especially webapps with weird names (that are running)"

This led to implementing fuzzy desktop file matching.

### On the Suspend/Resume Fix
> Human: "what did you change to make it work after suspend?"

The fix was changing from:
```rust
settings.anchor = Anchor::empty();  // Floating centered window
```
To:
```rust
settings.anchor = Anchor::TOP | Anchor::BOTTOM | Anchor::LEFT | Anchor::RIGHT;
```

---

## Release

Tagged and pushed as **v0.2.0** with commit message:
```
feat: Add running app detection and improve layer surface handling

- Add running app detection via ext_foreign_toplevel_list_v1 Wayland protocol
- Show grey arc indicators near inner circle for running apps
- Display non-favorite running apps in addition to dock favorites
- Improve desktop file matching for apps like Slack (com.slack.Slack)
- Use full-screen anchored layer surface for better suspend/resume compatibility
- Add subprocess-based running app query to avoid Wayland connection conflicts
- Add hard timeout fallback for cursor tracker
```

---

## Lessons Learned

1. **Process isolation for Wayland** - Multiple Wayland connections from one process can conflict; subprocess isolation is clean
2. **Surface strategy matters** - Full-screen anchored surfaces are more reliable than floating windows
3. **Protocol discovery** - Different compositors support different Wayland protocols; COSMIC uses `ext_` protocols
4. **Debug with events** - Seeing that input events worked while rendering failed was the key insight for the invisible window bug
